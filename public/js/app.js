function genKey(n){const a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";let s="";for(let i=0;i<n;i++)s+=a[Math.floor(Math.random()*a.length)];return s}
const sk=localStorage.getItem('session_key')||(()=>{const k=genKey(24);localStorage.setItem('session_key',k);return k})()
let station={ table_id:null, name:'', role:null }
const ioClient=io()
const elTable=document.querySelector('#recordsTable tbody')
const elCounters=document.getElementById('counters')
const elStation=document.getElementById('stationName')
let tablesMap={}
let dataCache=[]
const groupOrder=["Jardim II - A","Jardim II - B","1º Ano - A","1º Ano - B","2º Ano - A","2º Ano - B","3º Ano - A","3º Ano - B","4º Ano - A","4º Ano - B","5º Ano - A","5º Ano - B"]
function getLastBy(){try{const raw=localStorage.getItem('last_by')||'{}';return JSON.parse(raw)}catch(e){return {}}}
function setLastBy(id,field,name){const store=getLastBy();store[id]=store[id]||{};store[id][field]=name||'';localStorage.setItem('last_by',JSON.stringify(store))}
async function postJson(url,body){const r=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});if(!r.ok)throw new Error('Falha');return r.json()}
async function getJson(url){const r=await fetch(url);if(!r.ok)throw new Error('Falha');return r.json()}
function personIcon(){return '<svg class="icon" viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z"/><path d="M14 14s-1-4-6-4-6 4-6 4 2.686-2 6-2 6 2 6 2Z"/></svg>'}
function renderCounters(list){elCounters.innerHTML=''}
function rowHtml(r){const veio=r.veio? 'SIM':'NÃO';const chamado=r.chamado? 'SIM':'NÃO';const byVeio=r.altered_by_veio? `
<small class="alter-by">${personIcon()}${r.altered_by_veio}</small>`:'';const byChamado=r.altered_by_chamado? `
<small class="alter-by">${personIcon()}${r.altered_by_chamado}</small>`:'';return `<tr data-id="${r.id}"><td>${r.serie}</td><td>${r.aluno}</td><td>${r.mesa}</td><td class="toggle-cell"><button class="status-btn ${r.veio? 'yes':'no'}" data-field="veio">${r.veio? '✓ ':''}${veio}</button>${byVeio}</td><td class="toggle-cell"><button class="status-btn ${r.chamado? 'yes':'no'}" data-field="chamado">${r.chamado? '✓ ':''}${chamado}</button>${byChamado}</td><td>${r.produtos||''}</td></tr>`}
function renderRecords(list){dataCache=list;const groups={};for(const r of list){const k=String(r.serie||'').trim();(groups[k]=groups[k]||[]).push(r)}const keys=Object.keys(groups);const ordered=[...groupOrder.filter(k=>keys.includes(k)),...keys.filter(k=>!groupOrder.includes(k)).sort((a,b)=>a.localeCompare(b))];let html='';for(const k of ordered){const veioCount=(groups[k]||[]).reduce((s,it)=>s+(it.veio?1:0),0);const chamadoCount=(groups[k]||[]).reduce((s,it)=>s+(it.chamado?1:0),0);html+=`<tr class="group-row" data-group="${k}"><td>${k}</td><td></td><td></td><td class="group-stat veio"><span class="badge">Vieram: ${veioCount}</span></td><td class="group-stat chamado"><span class="badge">Chamados: ${chamadoCount}</span></td><td></td></tr>`;html+=groups[k].map(rowHtml).join('')}elTable.innerHTML=html;applyStatusStyles(list);wireRowButtons()}
function applyStatusStyles(list){const status={};const serverNames={};for(const r of list){serverNames[r.id]={veio:r.altered_by_veio||'',chamado:r.altered_by_chamado||''};status[r.id]={veio:!!r.veio,chamado:!!r.chamado}}const local=getLastBy();elTable.querySelectorAll('button[data-field]').forEach(btn=>{const tr=btn.closest('tr');const id=Number(tr.getAttribute('data-id'));const field=btn.getAttribute('data-field');const isYes=status[id]? !!status[id][field] : false;btn.textContent=`${isYes? '✓ ':''}${isYes? 'SIM':'NÃO'}`;btn.className=`status-btn ${isYes? 'yes':'no'}`;const name=(serverNames[id]? serverNames[id][field] : '') || (local[id]? local[id][field] : '');const td=btn.closest('td');if(td){let s=td.querySelector('small.alter-by');if(!s){s=document.createElement('small');s.className='alter-by text-success';td.appendChild(s)}s.innerHTML=name? `${personIcon()}${name}`:''}})}
function updateRowToggle(id,field,value,by){const tr=elTable.querySelector(`tr[data-id="${id}"]`);if(!tr)return;const btn=tr.querySelector(`button[data-field="${field}"]`);if(btn){btn.textContent=`${value? '✓ ':''}${value? 'SIM':'NÃO'}`;btn.className=`status-btn ${value? 'yes':'no'}`}const td=btn.closest('td');if(td){let s=td.querySelector('small.alter-by');if(!s){s=document.createElement('small');s.className='alter-by text-success';td.appendChild(s)}s.innerHTML=by? `${personIcon()}${by}`:''}
  const rec=dataCache.find(r=>r.id===id);if(rec){rec[field]=!!value}
  if(by) setLastBy(id, field, by)
  updateGroupCounts()
}
function isIdentified(){return station.name && !station.name.startsWith('Estação')}
function applyToggleEnabled(){const identified=isIdentified();const role=(station.role||'').toLowerCase();elTable.querySelectorAll('button[data-field]').forEach(btn=>{let enable=false;if(identified){if(role==='admin'){enable=true}else if(role==='apresentador'){enable=btn.getAttribute('data-field')==='chamado'}else if(role==='coxia'){enable=btn.getAttribute('data-field')==='veio'}else{enable=false}}btn.disabled=!enable;if(!enable)btn.classList.add('disabled-toggle');else btn.classList.remove('disabled-toggle')})}
function wireRowButtons(){applyToggleEnabled();elTable.querySelectorAll('button[data-field]').forEach(btn=>{btn.addEventListener('click',async ()=>{if(!isIdentified()){alert('Esta estação não está identificada. Renomeie com senha para alternar.');return}const tr=btn.closest('tr');const id=Number(tr.getAttribute('data-id'));const field=btn.getAttribute('data-field');try{const payload={ field, table_id: station.table_id, session_key: sk };const res=await postJson(`/api/record/${id}/toggle`,payload);}catch(e){}})})}
async function loadAll(){toggleLoading(true);try{const meta=await getJson('/api/last-reset');const ts=meta&&meta.ts? String(meta.ts):'';const prev=localStorage.getItem('last_reset')||'';if(ts && ts!==prev){try{localStorage.removeItem('last_by')}catch(e){};localStorage.setItem('last_reset',ts)} }catch(e){}const regs=await getJson('/api/records');renderRecords(regs);const cnt=await getJson('/api/counters');renderCounters(cnt);toggleLoading(false)}
async function registerStation(){const data=await postJson('/api/register-station',{ session_key: sk });station.table_id=data.table_id;station.name=data.name;const savedRole=localStorage.getItem('station_role');station.role=(data.role??savedRole??station.role)||null;if(data.role) localStorage.setItem('station_role', data.role);elStation.textContent=data.name;const rb=document.getElementById('roleBadge');if(rb)rb.textContent=station.role? station.role.charAt(0).toUpperCase()+station.role.slice(1):'Sem função';applyToggleEnabled()}
async function loadMyStationRole(){try{const data=await getJson(`/api/my-station?session_key=${encodeURIComponent(sk)}`);station.role=data.role||localStorage.getItem('station_role')||station.role||null;if(station.role) localStorage.setItem('station_role', station.role);const rb=document.getElementById('roleBadge');if(rb)rb.textContent=station.role? station.role.charAt(0).toUpperCase()+station.role.slice(1):'Sem função';applyToggleEnabled()}catch(e){}}
async function loadTables(){const list=await getJson('/api/tables');tablesMap={};for(const t of list){tablesMap[t.id]=t.name}}
document.getElementById('fullscreen').addEventListener('click',()=>{const d=document.documentElement;if(!document.fullscreenElement){d.requestFullscreen().catch(()=>{})}else{document.exitFullscreen().catch(()=>{})}})
const uploadModal=document.getElementById('uploadModal');uploadModal.addEventListener('shown.bs.modal',()=>{document.getElementById('uploadPassword').focus()})
const resetModal=document.getElementById('resetModal');resetModal.addEventListener('shown.bs.modal',()=>{document.getElementById('resetPassword').focus()})
const renameModal=document.getElementById('renameModal');renameModal.addEventListener('shown.bs.modal',()=>{document.getElementById('newName').focus()})
document.getElementById('uploadForm').addEventListener('submit',async e=>{e.preventDefault();const f=document.getElementById('uploadFile').files[0];const p=document.getElementById('uploadPassword').value;if(!f||!p){alert('Selecione o arquivo e digite a senha');return}const fd=new FormData();fd.append('file',f);fd.append('password',p);fd.append('table_id',String(station.table_id||''));const r=await fetch('/admin/upload-excel',{method:'POST',body:fd});if(r.ok){bootstrap.Modal.getInstance(uploadModal).hide();loadAll()}else{alert('Falha no upload')}})
document.getElementById('resetForm').addEventListener('submit',async e=>{e.preventDefault();const p=document.getElementById('resetPassword').value;try{await postJson('/admin/reset',{ password:p });bootstrap.Modal.getInstance(resetModal).hide()}catch(e){} })
document.getElementById('renameForm').addEventListener('submit',async e=>{e.preventDefault();const n=document.getElementById('newName').value;const p=document.getElementById('renamePassword').value;const roleSel=document.getElementById('renameRole').value||null;try{const r=await fetch('/admin/rename-table',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({ table_id: station.table_id, new_name: n, role: roleSel, password: p })});const data=await r.json().catch(()=>({}));if(!r.ok){alert(data.error||'Falha ao renomear');return}if(n){station.name=n;elStation.textContent=n}if(data.role||roleSel){station.role=(data.role||roleSel);localStorage.setItem('station_role', station.role);const rb=document.getElementById('roleBadge');if(rb)rb.textContent=station.role? station.role.charAt(0).toUpperCase()+station.role.slice(1):'Sem função';applyToggleEnabled()}bootstrap.Modal.getInstance(renameModal).hide()}catch(err){alert('Falha ao renomear')}})
ioClient.on('statusUpdate',payload=>{const name=payload.by_name||tablesMap[payload.table_id]||'';updateRowToggle(payload.record_id,payload.field,payload.value,name)})
ioClient.on('dataRefresh',payload=>{try{if(payload&&payload.reason==='reset'){localStorage.removeItem('last_by')}}catch(e){};loadAll()})
ioClient.on('counterUpdate',payload=>{renderCounters(payload)})
ioClient.on('tableRenamed',payload=>{if(station.table_id===payload.table_id){station.name=payload.name;elStation.textContent=payload.name;applyToggleEnabled()}})
;(async function(){try{await registerStation();await loadMyStationRole();await loadTables();await loadAll()}catch(e){}})()
function toggleLoading(on){const el=document.getElementById('loading-overlay');if(!el)return;el.className=on? '' : 'd-none'}
function updateGroupCounts(){const groups={};for(const r of dataCache){const k=String(r.serie||'').trim();(groups[k]=groups[k]||[]).push(r)}for(const k of Object.keys(groups)){const veioCount=groups[k].reduce((s,it)=>s+(it.veio?1:0),0);const chamadoCount=groups[k].reduce((s,it)=>s+(it.chamado?1:0),0);const row=document.querySelector(`tr.group-row[data-group="${CSS.escape(k)}"]`);if(row){const tdVeio=row.children[3];const tdChamado=row.children[4];if(tdVeio) tdVeio.querySelector('.badge').textContent=`Vieram: ${veioCount}`;if(tdChamado) tdChamado.querySelector('.badge').textContent=`Chamados: ${chamadoCount}`}}}
document.getElementById('search').addEventListener('input',e=>{const q=e.target.value.trim().toLowerCase();const filtered=!q? dataCache : dataCache.filter(r=>`${r.serie} ${r.aluno} ${r.mesa}`.toLowerCase().includes(q));renderRecords(filtered)})
// Funções de função (role)
function applyToggleEnabled(){const identified=isIdentified();const role=(station.role||'').toLowerCase();elTable.querySelectorAll('button[data-field]').forEach(btn=>{let enable=false;if(identified){if(role==='admin'){enable=true}else if(role==='apresentador'){enable=btn.getAttribute('data-field')==='chamado'}else if(role==='coxia'){enable=btn.getAttribute('data-field')==='veio'}else{enable=false}}btn.disabled=!enable;if(!enable)btn.classList.add('disabled-toggle');else btn.classList.remove('disabled-toggle')})}
async function loadMyStationRole(){try{const data=await getJson(`/api/my-station?session_key=${encodeURIComponent(sk)}`);station.role=data.role||station.role;const rb=document.getElementById('roleBadge');if(rb)rb.textContent=station.role? station.role.charAt(0).toUpperCase()+station.role.slice(1):'Sem função';applyToggleEnabled()}catch(e){}}
const roleModal=document.getElementById('roleModal');if(roleModal){roleModal.addEventListener('shown.bs.modal',()=>{document.getElementById('rolePassword').focus()});document.getElementById('roleForm').addEventListener('submit',async e=>{e.preventDefault();const sel=document.getElementById('roleSelect').value;const p=document.getElementById('rolePassword').value;try{const r=await fetch('/admin/set-role',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({ table_id: station.table_id, role: sel, password: p })});const data=await r.json().catch(()=>({}));if(!r.ok){alert(data.error||'Falha ao definir função');return}station.role=sel;localStorage.setItem('station_role', sel);const rb=document.getElementById('roleBadge');if(rb)rb.textContent=sel.charAt(0).toUpperCase()+sel.slice(1);applyToggleEnabled();bootstrap.Modal.getInstance(roleModal).hide()}catch(err){alert('Falha ao definir função')}})}
// Carrega função ao iniciar
loadMyStationRole()
// Limpa nomes locais após reset via evento global
ioClient.on('dataRefresh',payload=>{if(payload&&payload.reason==='reset'){try{localStorage.removeItem('last_by')}catch(e){}}})
// Limpa nomes locais após reset acionado por este cliente
document.getElementById('resetForm').addEventListener('submit',()=>{try{localStorage.removeItem('last_by')}catch(e){}}) 
