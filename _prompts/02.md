# üöÄ ESPECIFICA√á√ÉO T√âCNICA FINAL: Sistema de Gerenciamento de Registros em Tempo Real

## 1. VIS√ÉO GERAL E OBJETIVO

O objetivo √© desenvolver um sistema web robusto (Node.js/Express) com sincroniza√ß√£o em tempo real (Socket.IO) para gerenciar registros de presen√ßa de alunos (`veio`) e status de chamada (`chamado`). O sistema deve ser otimizado para deploy em ambiente cPanel com MySQL/MariaDB.

---

## 2. ARQUITETURA E TECNOLOGIAS

* **Backend (API & Socket.IO):** Node.js, Express, Socket.IO.
* **Banco de Dados:** MySQL/MariaDB (Usar o m√≥dulo `mysql2` ou ORM leve como `Knex.js` para melhor compatibilidade com Promises).
* **Processamento de Dados:** `multer` (Upload), `xlsx` (Leitura de Excel).
* **Frontend (UI):** HTML5, CSS3, Bootstrap 5.3 (Responsivo), JavaScript nativo (ES6+), Socket.IO Client.
* **Configura√ß√£o:** Vari√°veis de Ambiente (`.env`).
* **Deploy:** cPanel (Passenger).

---

## 3. MODELO DE DADOS (SQL DDL - Data Definition Language)

O script SQL de cria√ß√£o deve ser fornecido.

### 3.1. Tabela: `tables` (Gerenciamento de Identificadores)

| Campo | Tipo de Dado | Restri√ß√µes | Descri√ß√£o |
| :--- | :--- | :--- | :--- |
| `id` | INT | `PK`, `AUTO_INCREMENT` | Identificador √∫nico do Table. |
| `name` | VARCHAR(100) | `NOT NULL`, `UNIQUE` | Nome de exibi√ß√£o do Table (Ex.: "Sala A"). |
| `session_key` | VARCHAR(255) | `UNIQUE`, `NULLABLE` | Chave de sess√£o para persist√™ncia no cliente (para identifica√ß√£o inicial). |
| `created_at` | TIMESTAMP | `DEFAULT CURRENT_TIMESTAMP` | Data de cria√ß√£o. |

### 3.2. Tabela: `records` (Registros Principais)

| Campo | Tipo de Dado | Restri√ß√µes | Descri√ß√£o |
| :--- | :--- | :--- | :--- |
| `id` | INT | `PK`, `AUTO_INCREMENT` | ID do registro. |
| `serie` | VARCHAR(50) | `NOT NULL` | S√©rie/Turma. |
| `aluno` | VARCHAR(255) | `NOT NULL` | Nome completo do Aluno. |
| `mesa` | VARCHAR(50) | `NOT NULL` | Identificador da Mesa. |
| `veio` | BOOLEAN | `DEFAULT 0` | Status de presen√ßa (0=N√£o, 1=Sim). |
| `chamado` | BOOLEAN | `DEFAULT 0` | Status de chamada (0=N√£o, 1=Sim). |
| `produtos` | TEXT | | Detalhes dos Produtos. |
| `updated_at` | TIMESTAMP | `DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP` | Data da √∫ltima atualiza√ß√£o. |
| `unique_key` | VARCHAR(255) | `UNIQUE` | Chave composta para Upsert (Ex.: Hash de `serie`, `aluno`, `mesa`). |

### 3.3. Tabela: `logs` (Tabela de Logs e Auditoria)

| Campo | Tipo de Dado | Restri√ß√µes | Descri√ß√£o |
| :--- | :--- | :--- | :--- |
| `id` | INT | `PK`, `AUTO_INCREMENT` | ID do log. |
| `record_id` | INT | `FK` para `records.id`, `NULLABLE` | Registro afetado (se for um toggle). |
| `table_id` | INT | `FK` para `tables.id`, `NULLABLE` | Identificador da esta√ß√£o que realizou a altera√ß√£o. |
| `action_type` | VARCHAR(50) | `NOT NULL` | Tipo de a√ß√£o ('TOGGLE\_VEIO', 'EXCEL\_UPLOAD', 'GLOBAL\_RESET', 'RENAME\_TABLE'). |
| `details` | JSON | `NULLABLE` | Payload JSON com detalhes da mudan√ßa (Ex.: `{ field: 'veio', oldValue: 0, newValue: 1 }`). |
| `changed_at` | TIMESTAMP | `DEFAULT CURRENT_TIMESTAMP` | Data e hora da mudan√ßa. |

---

## 4. FUNCIONALIDADES OBRIGAT√ìRIAS (COM REFINAMENTO)

### 4.1. Interface e Persist√™ncia de Table
1.  **Persist√™ncia:** O nome do table (ID e Nome) deve ser persistido via **`localStorage`** ou **cookie** do cliente.
2.  **Renomea√ß√£o:**
    * A√ß√£o acionada via modal de senha.
    * Senha necess√°ria: **`Iesg510@`**.
    * O modal deve ter `autofocus` no campo de senha.
    * Atualizar o `tables.name` e emitir evento Socket.IO (`tableRenamed`).

### 4.2. Altern√¢ncia de Status (Toggles)
1.  **A√ß√£o:** Clique no campo **`Veio?`** ou **`Chamado?`** do registro.
2.  **Processamento:**
    * Chamar `POST /api/record/:id/toggle`.
    * Backend registra a altera√ß√£o na tabela `logs` (incluindo o `table_id` do cliente).
    * Backend emite evento Socket.IO: `statusUpdate` com ID, campo, novo valor e **Nome do Table Alterador**.
3.  **Visualiza√ß√£o:** Exibir na linha alterada: **‚ÄúAlterado por: [Nome do Table]‚Äù** (obtido do √∫ltimo log).

### 4.3. Carregamento via Excel (IMPORTA√á√ÉO)
1.  **Endpoint:** `POST /admin/upload-excel`.
2.  **Seguran√ßa:** Requer a senha **`Iesg510@`**.
3.  **Colunas Esperadas:** `S√©rie`, `Aluno`, `Mesa`, `Veio`, `Chamado`, `Produtos`.
4.  **L√≥gica:** Usar **Upsert** (INSERT ON DUPLICATE KEY UPDATE) baseada na `unique_key` para garantir que o upload n√£o duplique registros, apenas atualize.
5.  **Sincroniza√ß√£o:** Emiss√£o do evento Socket.IO: **`dataRefresh`** (for√ßa a recarga de dados e contadores em todos os clientes).

### 4.4. Reset Geral
1.  **Endpoint:** `POST /admin/reset`.
2.  **Seguran√ßa:** Requer a senha **`Iesg510@`**.
3.  **A√ß√£o:** Atualizar `veio` e `chamado` para `0` (FALSE) em **todos** os registros.
4.  **Log:** Registrar na tabela `logs` (`action_type: 'GLOBAL_RESET'`).
5.  **Sincroniza√ß√£o:** Emiss√£o do evento Socket.IO: **`dataRefresh`**.

### 4.5. Contadores por S√©rie (Dashboard no Topo)
1.  **Dados:**
    * `Contagem 'Veio' por S√©rie`
    * `Contagem 'Chamado' por S√©rie`
2.  **Atualiza√ß√£o:** Usar Socket.IO evento **`counterUpdate`** para atualizar dinamicamente, sem recarregar a p√°gina.

### 4.6. Sincroniza√ß√£o em Tempo Real (Socket.IO)
* Implementar cliente e servidor Socket.IO para os eventos:
    * `statusUpdate` (Toggle)
    * `dataRefresh` (Upload, Reset)
    * `counterUpdate` (Contadores)
    * `tableRenamed` (Renomea√ß√£o)

### 4.7. Est√©tica e Usabilidade
* **Logo:** Exibir o logo no topo: `https://saogoncalosp.com.br/wp-content/uploads/2025/10/logo_novo_h_350x100px.svg`
* **Bot√£o:** Criar um bot√£o "Tela Cheia" (Full Screen API).
* **UI/UX:** Tabela de registros responsiva, com filtros por s√©rie (sugest√£o).

---

## 5. ENDPOINTS (API REST - Express)

| M√©todo | Endpoint | Middleware | Par√¢metros/Body | Descri√ß√£o |
| :--- | :--- | :--- | :--- | :--- |
| `GET` | `/api/tables` | N/A | N/A | Lista `tables` e seus nomes. |
| `GET` | `/api/records` | N/A | `query: table_id` (opcional) | Lista registros com o √∫ltimo alterador (via JOIN com `logs`). |
| `GET` | `/api/counters` | N/A | N/A | Retorna a contagem agregada de `veio`/`chamado` por `serie`. |
| `POST`| `/api/record/:id/toggle` | N/A | `body: { field: 'veio'/'chamado', tableId }` | Alterna status, salva log e notifica. |
| `POST`| `/admin/upload-excel` | `CheckPassword` | `file (xlsx)`, `body: { password }` | Importa (Upsert), salva log e notifica. |
| `POST`| `/admin/reset` | `CheckPassword` | `body: { password }` | Reseta status, salva log e notifica. |
| `POST`| `/admin/rename-table` | `CheckPassword` | `body: { tableId, newName, password }` | Renomeia, salva log e notifica. |

---

## 6. SEGURAN√áA E CONFIGURA√á√ÉO

### 6.1. Vari√°veis de Ambiente (`.env`)
O c√≥digo deve carregar as configura√ß√µes via `.env` (Usar `dotenv`).

* `ADMIN_PASSWORD=Iesg510@`
* `DB_HOST`, `DB_USER`, `DB_PASSWORD`, `DB_NAME`
* `PORT` (Ex.: 3000)

### 6.2. Middleware de Senha
* Criar um middleware **`CheckPassword`** no backend.
* Ele deve comparar a senha enviada (`req.body.password`) com o valor de **`ADMIN_PASSWORD`** (do `.env`).
* Todas as rotas `/admin/*` devem usar este middleware.

---

## 7. ENTREG√ÅVEIS OBRIGAT√ìRIOS

1.  **C√≥digo Completo:** Estruturado em pastas (`server`, `public`, `routes`, `db`, etc.).
2.  **Scripts SQL:** Arquivo `.sql` para cria√ß√£o das tr√™s tabelas.
3.  **Template Excel:** Arquivo `.xlsx` de exemplo com as colunas esperadas.
4.  **README.md:** Instru√ß√µes de Instala√ß√£o e Deploy no cPanel detalhadas.
5.  **Estrutura do Projeto:** C√≥digo organizado, comentado e seguindo boas pr√°ticas (separa√ß√£o de responsabilidades).